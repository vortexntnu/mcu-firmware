#include "efm32gg990f1024.h"
#include <string.h>

#include "../include/uart.h"
#include "../include/pwm.h"

int main() {


	CHIP_Init();

	initUart();
	initPwm();

	uint8_t i;
	char hello_world[] = "\n\rHello World!\n\r";
	char receive_buff = 0;

	// Print test string
  	for(i=0; i<strlen(hello_world); i++) {
    	while( !(USART1->STATUS & (1 << 6)) ); // wait for TX buffer to empty
    	USART1->TXDATA = hello_world[i];       // print each character of the test string
  	}

	for(i=0; i<strlen(hello_world); i++) USART_Tx(UART, hello_world[i]);

	while(1)  {

		receive_buff = USART_Rx(UART);

		USART_Tx(UART, receive_buff);

		    if(ms_counter == UPDATE_PERIOD) {
		      if(inc) {                                    // If increment = true
		        compare_val += INC_VAL;                    // Increase the compare value
		      }else{                                       // increment = false
		        compare_val -= INC_VAL;                    // Decrease the compare value
		      }
		      TIMER_CompareBufSet(TIMER3, 2, compare_val); // Write new value to compare buffer
		      GPIO_PinOutToggle(gpioPortE, 3);             // Toggle LED1
		      ms_counter = 0;                              // Reset counter
		    }
		    if(compare_val > (TOP_VAL_PWM-1)) { inc = 0; } // If compare value is at max, start decrementing
		    if(compare_val < 1) { inc = 1; }               // If compare value is at min, start incrementing


	}

}


